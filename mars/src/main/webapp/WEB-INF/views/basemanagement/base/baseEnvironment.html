<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
  xmlns:vu="http://www.morphbit.com/thymeleaf/component"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{templates/mmcDetailNavLayout}"
>
	<head>
		<title>Environment</title>
		
		<!-- graphs -->
		<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.0/Chart.bundle.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-color/1.0.3/d3-color.min.js" ></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-interpolate/1.1.5/d3-interpolate.min.js" ></script>
		<script th:src="@{/dashboard/static/dashboard.js}"></script>
		<script th:src="@{/dashboard/static/dashboard.chartjs.js}"></script>
		<script type="text/javascript">
			VUiExtensions.dataX.alertButton = {pushed : false};
			VUiExtensions.methods.ajaxPostAlert = function ajaxPostAlert(url) { 
				if(!this.dataX.alertButton.pushed) {
					this.dataX.alertButton.pushed = true;
					var params = {};
					params['CTX'] = this.vueData.CTX;
					 this.$http.post(url, params , { emulateJSON: true })
					.then( function (response ) {
						if (response.body.CTX) {
							this.vueData.CTX = response.body.CTX;
						}
					});
				} else {
					this.dataX.alertButton.pushed = false;
				}
			}
		</script>
	</head>
	
	<body>
	
		<section layout:fragment="content-nav">
			<nav v-scroll-spy="{offset:150}">
			    <q-list link style="height:100%">
			        <q-item tag="a" href="#weatheroverview">Weather Overview</q-item>
			        <q-item tag="a" href="#farmoverview">Farm Overview</q-item>
			        <q-item tag="a" href="#securityoverview">Security overview</q-item>
			        <q-item tag="a" href="#collaboratoroverview">Personnel overview</q-item>				      
	        	</q-list>
	        </nav>
		</section>
	
		<section>
				<div layout:fragment="content-header-left" th:include="basemanagement/base/baseInformation :: #baseImg"></div>				
				<div layout:fragment="content-header-title" th:include="basemanagement/base/baseInformation :: #baseTitle"></div>
				<div layout:fragment="content-header-actions" th:include="basemanagement/base/baseInformation :: #baseActions"></div>
				<div layout:fragment="content-header-tabs">
					<q-btn flat type="a" th:href="@{/basemanagement/base/information/} + ${model.base.baseId}">Base Informations</q-btn>
					<q-btn flat type="a" th:href="@{/basemanagement/base/equipment/} + ${model.base.baseId}">Equipment</q-btn>
					<q-btn flat type="a" class="active" th:href="@{/basemanagement/base/environment/} + ${model.base.baseId}">Environment</q-btn>			
					<q-btn flat type="a" th:href="@{/basemanagement/base/vr/} + ${model.base.baseId}">VR View</q-btn>		
				</div>
		</section>	
			
	
		<section layout:fragment="content" >
			<vu:block id="weatheroverview" title="Weather Overview" icon="fas fa-sun">
				<div class="row gutter-xl" >
					<div class="col-md-6 col-xs-12 text-center">
						<div class="q-title">Current Temperature</div>
						<q-knob
							th::value="${model.lastTemperature}"
							:min="0"
							:max="50"
							:decimals="1"
							color="orange"
							:readonly="true" style="font-size: 2rem">
						</q-knob>
							<div class="chart chartjs linechart bg-white" 
						   		th:data-url="@{/api/basemanagment/equipment/environment/data/series}" 
						   		data-query-measures='["value:mean"]'
						   		data-query-data-filter='{ "measurement": "temperature", "filters": {"equipment": "*"}}'
						   		data-query-time-filter='{ "from": "now() - 3d", "to": "now()", "dim": "1h"}'
						   		data-labels='{"value:mean":"Mean Value from temperature"}' 
						   		data-colors='iGREEN2BLUE'></div> 
					</div>
					<div class="col-md-6 col-xs-12 text-center">
						<div class="q-title">Current Humidity</div>
						<q-knob
							th::value="${model.lastHumidity}"
							:min="0"
							:max="50"
							:decimals="1"
							color="blue"
							:readonly="true" style="font-size: 2rem">
						</q-knob>
							<div class="chart chartjs linechart bg-white" 
							   th:data-url="@{/api/basemanagment/equipment/environment/data/series}" 
							   data-query-measures='["value:mean"]'
							   data-query-data-filter='{ "measurement": "humidite", "filters": {"equipment": "*"}}'
							   data-query-time-filter='{ "from": "now() - 3d", "to": "now()", "dim": "1h"}'
							   data-labels='{"value:mean":"Mean Value Humitidy"}' 
							   data-colors='iRED2GREEN'></div> 			
					</div>							
				</div>
			</vu:block>

			<vu:block id="farmoverview" title="Farm Overview" icon="fas fa-tractor">
				<div class="row">
					<div class="col-md-6 col-xs-12 text-center gutter-xs">
						<!-- TODO Farm to water -->
						<div class="q-title">Farms to water: </div>
					</div>
					<div class="col-md-6 col-xs-12 text-center gutter-xs">
							<div class="chart chartjs linechart bg-white" 
								th:data-url="@{/api/basemanagment/equipment/environment/data/series}" 
								data-query-measures='["value:mean"]'
								data-query-data-filter='{ "measurement": "moisture", "filters": {"equipment": "*"}}'
								data-query-time-filter='{ "from": "now() - 1d", "to": "now()", "dim": "1h"}'
								data-labels='{"value:mean":"Soil moisture"}' 
								data-colors='iGREEN:INTENSITY'></div> 				
					</div>
				</div>
			</vu:block>
			
			<vu:block id="securityoverview" title="Security Overview" icon="fas fa-lock">
				<div class="row gutter-xs">
					<div class="col-md-6 col-xs-12 text-center gutter-xs">
						<div class="q-title">Triggered alarm this month:</div>
						<!-- TODO  appel du nombre d'alerte dï¿½clenchï¿½ ce mois-ci tout ï¿½quipement de sï¿½curitï¿½ confondu-->
						<!-- TODO Graphe qui somme l'ensemble des alertes des ï¿½quipements de sï¿½curitï¿½ et fait un graphe  -->
					</div>		
					<div class="col-md-6 col-xs-12 text-center gutter-xs">
						<!-- TODO  GROS bouton pour déclencher l'alarme  -->
						<q-btn rounded push th:@click="|ajaxPostAlert('@{_alert}')|" :class="'on-left '+(dataX.alertButton.pushed?'inset-shadow':'shadow-8')" 
						size="lg" color="red"  icon="fas fa-exclamation-circle"  icon-right="fas fa-exclamation-circle"
						aria-label="Triggered alarm in base" title="Triggered alarm in base" >Alert</q-btn>
					
						<!-- TODO une boite texte pour envoyer message au panneau d'affichage  -->
						<div class="stacked-label">
						  <textarea class="full-width"></textarea>
						  <label>Send a message to the Led Displayer Panel</label>
						</div>
					</div>
				</div>
				
			</vu:block>
			
			<vu:block id="collaboratoroverview" title="Collaborator Overview" icon="fas fa-user">
				Work in progress
			</vu:block>
		</section>
		
		<section layout:fragment="javscript-footer" >
			<script type="text/javascript">
				showCharts();
			</script>
		</section>
	</body>
</html>